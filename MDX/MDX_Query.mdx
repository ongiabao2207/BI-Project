-- Query 1: Truy vấn tổng số chuyến bay theo tháng, quý, năm.
SELECT NON EMPTY
    [Depart Date].[Hierarchy].[Year]
	*[Depart Date].[Quarter].[Quarter]
	*[Depart Date].[Month].[Month] ON ROWS,
    [Measures].[Fact Flight Count] ON COLUMNS
FROM [Project DDS DB];


-- Query 2: Top 5 sân bay bận rộn nhất (có nhiều chuyến bay đi và đến nhất).
WITH MEMBER [Measures].[Total Traffic] AS
    -- Tổng chuyến bay tại sân bay đó với tư cách là điểm đi + điểm đến
    ([Origin Airport].[Airport Name].CurrentMember, [Measures].[Fact Flight Count]) + 
    ([Dest Airport].[Airport Name].CurrentMember, [Measures].[Fact Flight Count])
SELECT 
    [Measures].[Total Traffic] ON COLUMNS,
    TOPCOUNT(
        [Origin Airport].[Airport Name].[Airport Name].MEMBERS, 
        5, 
        [Measures].[Total Traffic]
    ) ON ROWS
FROM [Project DDS DB];


-- Query 3: Tỉ lệ chuyến bay đúng giờ (On-Time Performance - OTP) ± 5 theo sân bay.
WITH
MEMBER [Measures].[OTP Rate] AS
    [Measures].[OnTime Flight Count] 
    / 
    [Measures].[Fact Flight Count],
    FORMAT_STRING = "Percent"
SELECT
    [Measures].[OTP Rate] ON COLUMNS,
    [Dest Airport].[Airport Name].MEMBERS ON ROWS
FROM [Project DDS DB];


-- Query 4: Tỉ lệ hủy chuyến theo nguyên nhân.
WITH MEMBER [Measures].[Cancellation Rate] AS
    DIVIDE(
        [Measures].[Fact Flight Count],
        ([Measures].[Fact Flight Count], [Dim Reason].[Reason Name].[All]),
        0
    ), FORMAT_STRING = "0.00%"

SELECT 
    { [Measures].[Fact Flight Count], [Measures].[Cancellation Rate] } ON COLUMNS,
    EXCEPT(
        [Dim Reason].[Reason Name].CHILDREN, 
        { [Dim Reason].[Reason Name].[Unknown] }
    ) ON ROWS
FROM [Project DDS DB];


-- Query 5: Trung bình thời gian delay theo sân bay đi/đến
WITH 
MEMBER [Measures].[Avg Depart Delay] AS 
    DIVIDE([Measures].[Total Depart Delay], [Measures].[Fact Flight Count], 0)

MEMBER [Measures].[Avg Arrive Delay] AS 
    DIVIDE([Measures].[Total Arrive Delay], [Measures].[Fact Flight Count], 0)

SELECT 
    { [Measures].[Avg Depart Delay], [Measures].[Avg Arrive Delay] } ON COLUMNS,
    NON EMPTY [Origin Airport].[Airport Name].CHILDREN ON ROWS
FROM [Project DDS DB];


-- Query 6: Xu hướng arrive delay trung bình theo tháng/mùa
WITH
MEMBER [Measures].[Avg Delay] AS
    IIF(
        [Measures].[Fact Flight Count] = 0,
        0,
        [Measures].[Total Arrive Delay] / [Measures].[Fact Flight Count]
    )

SELECT
    {[Measures].[Avg Delay]} ON COLUMNS,
    [Arrive Date].[Season].[Season]
	*[Arrive Date].[Month].[Month].MEMBERS ON ROWS
FROM [Project DDS DB];